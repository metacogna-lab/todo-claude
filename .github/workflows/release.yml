name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Optional image tag override"
        required: false

jobs:
  docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.22"

      - run: bun install --frozen-lockfile
      - run: bun run lint
      - run: bun test

      - name: Configure image metadata
        id: meta
        run: |
          REGISTRY=${{ vars.CONTAINER_REGISTRY != '' && vars.CONTAINER_REGISTRY || 'ghcr.io' }}
          IMAGE=${REGISTRY}/${{ vars.CONTAINER_IMAGE_NAME != '' && vars.CONTAINER_IMAGE_NAME || github.repository }}
          echo "registry=$REGISTRY" >> "$GITHUB_OUTPUT"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

      - uses: docker/login-action@v3
        with:
          registry: ${{ steps.meta.outputs.registry }}
          username: ${{ secrets.REGISTRY_USERNAME != '' && secrets.REGISTRY_USERNAME || github.actor }}
          password: ${{ secrets.REGISTRY_PASSWORD != '' && secrets.REGISTRY_PASSWORD || secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        run: |
          TAG=${{ github.ref_name }}
          if [ -n "${{ inputs.image_tag }}" ]; then
            TAG=${{ inputs.image_tag }}
          fi
          IMAGE=${{ steps.meta.outputs.image }}
          docker build -t $IMAGE:$TAG .
          docker tag $IMAGE:$TAG $IMAGE:latest

      - name: Push Docker image
        run: |
          TAG=${{ github.ref_name }}
          if [ -n "${{ inputs.image_tag }}" ]; then
            TAG=${{ inputs.image_tag }}
          fi
          IMAGE=${{ steps.meta.outputs.image }}
          docker push $IMAGE:$TAG
          docker push $IMAGE:latest
